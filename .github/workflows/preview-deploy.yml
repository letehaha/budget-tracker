name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  pull-requests: write

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PR_NUMBER: ${{ github.event.pull_request.number }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >-
      github.event.pull_request.base.ref == 'main'
      && github.event.pull_request.head.repo.full_name == github.repository
      && contains(github.event.pull_request.labels.*.name, 'preview')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Disk space check ──────────────────────────────────────────────
      - name: Check VPS disk space
        id: disk-check
        uses: appleboy/ssh-action@v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_KEY_PASSPHRASE }}
          script: |
            AVAIL_KB=$(df / --output=avail | tail -1 | tr -d ' ')
            AVAIL_GB=$(echo "scale=2; $AVAIL_KB / 1024 / 1024" | bc)
            echo "Available disk space: ${AVAIL_GB}GB"
            if [ "$AVAIL_KB" -lt 2097152 ]; then
              echo "ERROR: Less than 2GB free disk space!"
              exit 1
            fi

      - name: Comment on PR if disk space low
        if: failure() && steps.disk-check.outcome == 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-env
          message: |
            ## Preview Environment

            :x: **Deploy failed** — VPS has less than 2GB free disk space. Please clean up before retrying.

      # ── Build and push Docker images ──────────────────────────────────
      - name: Build and push frontend image
        uses: ./.github/actions/frontend-docker-build
        with:
          api-base-url: https://api-pr-${{ env.PR_NUMBER }}.preview.moneymatter.app
          vue-app-api-ver: /api/v1
          image-tag: pr-${{ env.PR_NUMBER }}
          docker-hub-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker-hub-access-token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          push: 'true'

      - name: Build and push backend image
        uses: ./.github/actions/backend-docker-build
        with:
          image-tag: pr-${{ env.PR_NUMBER }}
          docker-hub-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          docker-hub-access-token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          push: 'true'

      # ── Copy compose file to VPS ──────────────────────────────────────
      - name: Create PR directory on VPS
        uses: appleboy/ssh-action@v1.2.5
        env:
          VPS_PREVIEW_BASE_PATH: ${{ secrets.VPS_PREVIEW_BASE_PATH }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_KEY_PASSPHRASE }}
          envs: PR_NUMBER,VPS_PREVIEW_BASE_PATH
          script: mkdir -p "$VPS_PREVIEW_BASE_PATH/pr-$PR_NUMBER"

      - name: Copy compose file to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_KEY_PASSPHRASE }}
          source: docker/preview/docker-compose.preview.yml
          target: ${{ secrets.VPS_PREVIEW_BASE_PATH }}/pr-${{ env.PR_NUMBER }}/
          strip_components: 2

      # ── Deploy ────────────────────────────────────────────────────────
      - name: Deploy preview environment
        uses: appleboy/ssh-action@v1.2.5
        env:
          VPS_PREVIEW_BASE_PATH: ${{ secrets.VPS_PREVIEW_BASE_PATH }}
          PREVIEW_DB_PASSWORD: ${{ secrets.PREVIEW_DB_PASSWORD }}
          PREVIEW_JWT_SECRET: ${{ secrets.PREVIEW_JWT_SECRET }}
          PREVIEW_SESSION_SECRET: ${{ secrets.PREVIEW_SESSION_SECRET }}
          PREVIEW_BETTER_AUTH_SECRET: ${{ secrets.PREVIEW_BETTER_AUTH_SECRET }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          passphrase: ${{ secrets.VPS_SSH_KEY_PASSPHRASE }}
          envs: PR_NUMBER,VPS_PREVIEW_BASE_PATH,PREVIEW_DB_PASSWORD,PREVIEW_JWT_SECRET,PREVIEW_SESSION_SECRET,PREVIEW_BETTER_AUTH_SECRET,R2_ENDPOINT,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET
          command_timeout: 10m
          script: |
            set -eo pipefail
            cd "$VPS_PREVIEW_BASE_PATH/pr-$PR_NUMBER"

            # Ensure backup file is cleaned up on failure
            BACKUP_FILE="/tmp/preview-pr-${PR_NUMBER}-backup.sql.gz"
            trap "rm -f '$BACKUP_FILE'" EXIT

            export PR_NUMBER PREVIEW_DB_PASSWORD

            # ── Detect first deploy vs update ──
            if [ -f .env ]; then
              echo "=== UPDATE DEPLOY ==="

              # Pull new images
              docker compose -f docker-compose.preview.yml -p preview-pr-$PR_NUMBER pull frontend backend

              # Restart only frontend and backend (DB stays untouched)
              docker compose -f docker-compose.preview.yml -p preview-pr-$PR_NUMBER up -d --no-deps frontend backend

              echo "Preview environment updated successfully!"
            else
              echo "=== FIRST DEPLOY ==="

              # Discover shared service container names dynamically
              CURRENCY_RATES_CONTAINER=$(docker ps --format '{{.Names}}' | grep -E 'currency-rates-api' | head -1)
              FRANKFURTER_CONTAINER=$(docker ps --format '{{.Names}}' | grep -E 'frankfurter' | head -1)

              if [ -z "$CURRENCY_RATES_CONTAINER" ] || [ -z "$FRANKFURTER_CONTAINER" ]; then
                echo "ERROR: Could not find shared service containers"
                echo "  currency-rates-api: ${CURRENCY_RATES_CONTAINER:-NOT FOUND}"
                echo "  frankfurter: ${FRANKFURTER_CONTAINER:-NOT FOUND}"
                exit 1
              fi

              echo "Found shared services:"
              echo "  currency-rates-api: $CURRENCY_RATES_CONTAINER"
              echo "  frankfurter: $FRANKFURTER_CONTAINER"

              # Generate .env file
              printf '%s\n' \
                "NODE_ENV=production" \
                "APPLICATION_HOST=0.0.0.0" \
                "APPLICATION_PORT=8080" \
                "APPLICATION_JWT_SECRET=$PREVIEW_JWT_SECRET" \
                "APPLICATION_DB_HOST=preview-pr-${PR_NUMBER}-db" \
                "APPLICATION_DB_PORT=5432" \
                "APPLICATION_DB_USERNAME=preview" \
                "APPLICATION_DB_PASSWORD=$PREVIEW_DB_PASSWORD" \
                "APPLICATION_DB_DATABASE=budget_tracker_preview" \
                "APPLICATION_DB_DIALECT=postgres" \
                "APPLICATION_REDIS_HOST=preview-pr-${PR_NUMBER}-redis" \
                "ALLOWED_ORIGINS=https://pr-${PR_NUMBER}.preview.moneymatter.app" \
                "APP_SESSION_ID_SECRET=$PREVIEW_SESSION_SECRET" \
                "BETTER_AUTH_SECRET=$PREVIEW_BETTER_AUTH_SECRET" \
                "BETTER_AUTH_URL=https://pr-${PR_NUMBER}.preview.moneymatter.app" \
                "AUTH_RP_ID=pr-${PR_NUMBER}.preview.moneymatter.app" \
                "AUTH_ORIGIN=https://pr-${PR_NUMBER}.preview.moneymatter.app" \
                "AUTH_RP_NAME=MoneyMatter-Preview" \
                "CURRENCY_RATES_API_URL=http://${CURRENCY_RATES_CONTAINER}:8080" \
                "FRANKFURTER_BASE_URL=http://${FRANKFURTER_CONTAINER}:8080" \
                "PREVIEW_DB_PASSWORD=$PREVIEW_DB_PASSWORD" \
                > .env

              # Start DB + Redis first
              docker compose -f docker-compose.preview.yml -p preview-pr-$PR_NUMBER up -d db redis

              # Wait for DB to be healthy
              echo "Waiting for database to be healthy..."
              for i in $(seq 1 30); do
                if docker exec preview-pr-${PR_NUMBER}-db pg_isready -U preview -d budget_tracker_preview > /dev/null 2>&1; then
                  echo "Database is ready!"
                  break
                fi
                if [ "$i" = "30" ]; then
                  echo "ERROR: Database failed to start within 150s"
                  exit 1
                fi
                sleep 5
              done

              # Download latest valid R2 backup and restore (skip files < 1KB)
              echo "Downloading latest database backup from R2..."
              LATEST_BACKUP=$(AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID" \
                AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY" \
                aws s3 ls "s3://${R2_BUCKET}/backups/" \
                  --endpoint-url "$R2_ENDPOINT" \
                | sort | awk '$3 > 1024 {file=$4} END {print file}')

              if [ -z "$LATEST_BACKUP" ]; then
                echo "WARNING: No backup found in R2. Starting with empty database."
              else
                echo "Restoring backup: $LATEST_BACKUP"
                AWS_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID" \
                AWS_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY" \
                aws s3 cp "s3://${R2_BUCKET}/backups/${LATEST_BACKUP}" "$BACKUP_FILE" \
                  --endpoint-url "$R2_ENDPOINT"

                # Drop and recreate DB to ensure clean restore
                docker exec -i preview-pr-${PR_NUMBER}-db psql -U preview -d postgres \
                  -c "DROP DATABASE IF EXISTS budget_tracker_preview;" \
                  -c "CREATE DATABASE budget_tracker_preview OWNER preview;"

                gunzip -c "$BACKUP_FILE" | \
                  docker exec -i preview-pr-${PR_NUMBER}-db psql -U preview -d budget_tracker_preview

                echo "Database restore completed!"
              fi

              # Start the full stack (backend will auto-run migrations)
              docker compose -f docker-compose.preview.yml -p preview-pr-$PR_NUMBER up -d

              echo "Preview environment deployed successfully!"
            fi

      # ── Comment on PR ─────────────────────────────────────────────────
      - name: Comment on PR with preview URLs
        if: success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-env
          message: |
            ## Preview Environment

            :white_check_mark: Preview deployed successfully!

            | Service | URL |
            |---------|-----|
            | Frontend | https://pr-${{ env.PR_NUMBER }}.preview.moneymatter.app |
            | API | https://api-pr-${{ env.PR_NUMBER }}.preview.moneymatter.app |

            _Last deployed: ${{ github.sha }} at ${{ github.event.pull_request.updated_at }}_

      - name: Comment on PR if deploy failed
        if: failure() && steps.disk-check.outcome != 'failure'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-env
          message: |
            ## Preview Environment

            :x: **Deploy failed.** Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

  # ── E2E Tests against preview ────────────────────────────────────
  test-preview:
    runs-on: ubuntu-latest
    needs: deploy
    if: success()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: prepare-env
        uses: ./.github/actions/prepare-local-env

      - name: Install dependencies
        if: steps.prepare-env.outputs.cache-hit != 'true'
        run: npm ci --ignore-scripts

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
        working-directory: packages/frontend

      - name: Run Playwright tests
        id: playwright
        continue-on-error: true
        run: npm run test:e2e -w packages/frontend
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: https://pr-${{ env.PR_NUMBER }}.preview.moneymatter.app
          PLAYWRIGHT_API_BASE_URL: https://api-pr-${{ env.PR_NUMBER }}.preview.moneymatter.app

      - name: Check if failure was due to teardown
        if: steps.playwright.outcome == 'failure'
        id: teardown-check
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://pr-${{ env.PR_NUMBER }}.preview.moneymatter.app" || echo "000")
          if [ "$HTTP_CODE" = "000" ] || [ "$HTTP_CODE" = "502" ] || [ "$HTTP_CODE" = "503" ]; then
            echo "teardown_detected=true" >> $GITHUB_OUTPUT
          else
            echo "teardown_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-pr-${{ env.PR_NUMBER }}
          path: packages/frontend/playwright-report/
          retention-days: 7

      - name: Comment test results on PR
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: playwright-tests
          message: |
            ## Playwright E2E Tests

            ${{ steps.playwright.outcome == 'success' && ':white_check_mark: **All tests passed!**' || '' }}
            ${{ steps.playwright.outcome == 'failure' && steps.teardown-check.outputs.teardown_detected == 'true' && ':warning: **Tests interrupted** — preview environment was torn down during the test run.' || '' }}
            ${{ steps.playwright.outcome == 'failure' && steps.teardown-check.outputs.teardown_detected != 'true' && ':x: **Some tests failed.** Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and the uploaded `playwright-report` artifact for details.' || '' }}

            _Tested against: `pr-${{ env.PR_NUMBER }}.preview.moneymatter.app` · Commit: ${{ github.sha }}_

      - name: Fail if real test failures
        if: steps.playwright.outcome == 'failure' && steps.teardown-check.outputs.teardown_detected != 'true'
        run: exit 1
